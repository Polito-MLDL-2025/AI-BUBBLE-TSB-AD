# Chronos2Ada Anomaly Detection

**Chronos2Ada** is an anomaly detection algorithm leveraging the **Chronos-2** time series forecasting model (by Amazon). It detects anomalies by comparing the actual observed values with the probabilistic forecasts generated by the Chronos-2 model.

## How it Works

The algorithm operates in a sliding window fashion:

1.  **Forecasting**: For each time step $t$, the model uses the preceding `context_length` data points to predict the distribution of the next value ($t+1$). It generates quantiles (low, mid, high) for this prediction.
2.  **Uncertainty & Error Estimation**:
    *   **Uncertainty Width ($W_t$)**: The difference between the high and low quantiles ($Q_{high} - Q_{low}$). This represents the model's uncertainty.
    *   **Prediction Error ($E_t$)**: The absolute difference between the actual observed value and the median predicted value ($|y_{t} - Q_{mid}|$).
3.  **Dynamic Thresholding (Adaptive)**:
    *   The algorithm maintains a history (rolling buffer) of $W_t$ and $E_t$.
    *   It calculates a "Safe Width" ($S_t$) which acts as a dynamic threshold.
    *   $S_t = \text{Quantile}(W_{history}, \alpha) + \text{err_multiplier} \times \text{Aggregate}(E_{history})$
    *   This threshold adapts to the recent volatility and prediction performance of the model.
4.  **Anomaly Scoring**:
    *   The anomaly score is calculated as:
        $$ \text{Score}_t = \frac{\max(W_t, E_t)}{S_t} $$
    *   If the model is very uncertain ($W_t$ is large) or the prediction error is high ($E_t$ is large) relative to the safe width, the score increases.

## Simple numerical example

Assume a single channel with:
* Warmup window: $3$
* $\alpha = 0.8$
* $\text{err_multiplier} = 1.0$

After warmup,
the history buffers contain:

- width history: $W_{history}=[0.8, 1.0, 1.2]$
- error history: $E_{history}=[0.1, 0.2, 0.3]$

At time `t`, Chronos-2 predicts quantiles:

* $Q_{\text{low},t} = 9.0$
* $Q_{\text{mid},t} = 10.0$
* $Q_{\text{high},t} = 11.0$

Observed value is $y_t = 12.2$.

Compute:
- **Uncertainty Width**: $W_t = Q_{\text{high},t} - Q_{\text{low},t} = 11.0 - 9.0 = 2.0$
- **Prediction error**: $E_t = |y_t - Q_{\text{mid},t}| = |12.2 - 10.0| = 2.2$
-  **Quantile of width history**: $\text{Quantile}({0.8, 1.0, 1.2}, \alpha = 0.8) \approx 1.12$
- **Aggregate error (mean)**: $\text{Aggregate}(E_{\text{history}}) = (0.1 + 0.2 + 0.3)/3 = 0.2$
- **Safe width**: $S_t = \text{Quantile}(W_{\text{history}}, \alpha) + \text{err_multiplier} \times \text{Aggregate}(E_{\text{history}}) \approx 1.12 + 1.0 \times 0.2 = 1.32$
- **Anomaly score**: $\text{Score}_t = \dfrac{\max(W_t, E_t)}{S_t} = \dfrac{\max(2.0, 2.2)}{1.32} = \dfrac{2.2}{1.32} \approx 1.67$

Since the score is greater than 1.0, this step is flagged as anomalous.

**Note**: In case of multivariate data, the scores from all channels are aggregated (e.g., by taking the maximum) to produce a single anomaly score per time step.

## Model Wrappers

The `TSB_AD/model_wrapper.py` provides two main functions to run Chronos2Ada:

### 1. `run_Chronos2Ada`
This is a standard wrapper that initializes and runs the `Chronos2Ada` model with explicit parameters. We must manually specify the `context_length` and other hyperparameters.

### 2. `run_Sub_Chronos2Ada`
This is an advanced wrapper that automatically tunes hyperparameters based on the **periodicity** of the input data.

*   **Periodicity Detection**: It uses `find_length_rank(data, rank=periodicity)` to identify the dominant cycle length of the time series.
*   **Automatic `context_length`**: It sets the model's lookback window as a multiple of the period (`slidingWindow * per_context`). It also ensures the value stays within a safe range for the Chronos-2 model (typically 10 to 2048).
*   **Automatic `max_history`**: It sets the size of the rolling buffers used for thresholding as a multiple of the period (`slidingWindow * per_history`). This ensures the "Safe Width" is calculated based on a relevant window of past seasonal behavior.

## Key Parameters

| Parameter | Default | Description |
| :--- | :--- | :--- |
| `model_name` | "amazon/chronos-2" | The Hugging Face model ID for the Chronos-2 model. |
| `context_length` | 64 | Number of past time steps to use for prediction. |
| `prediction_length` | 1 | Number of steps to predict (usually 1 for anomaly detection). |
| `warmup` | 50 | Number of steps to wait before calculating valid scores (to fill history buffers). |
| `quantile_low` | 0.01 | The lower quantile for the prediction interval (e.g., 1st percentile). |
| `quantile_mid` | 0.5 | The median quantile (50th percentile) for point prediction. |
| `quantile_high` | 0.99 | The upper quantile for the prediction interval (e.g., 99th percentile). |
| `alpha` | 0.99 | The quantile used for the historical width buffer when calculating Safe Width. |
| `err_multiplier` | 2.0 | Multiplier for the historical error component of the Safe Width. |
| `error_agg` | "mean" | Aggregation method for the historical error buffer. Supported: `"mean"`, `"median"`, `"mode"`, or `"pXX"` (e.g., `"p95"` for 95th percentile). |
| `skip_anomaly_updates` | False | If True, detected anomalies are excluded from updating the history buffers to prevent model adaptation to anomalies. |
